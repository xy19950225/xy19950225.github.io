---
title: "SQL çª—å£å‡½æ•°æ€»ç»“"
date: 2020-11-13T16:30:05+08:00
lastmod: 2020-11-13T16:30:05+08:00
draft: false

tags: ["SQL", "çª—å£å‡½æ•°"]
categories: ["æŠ€æœ¯"]
hiddenFromHomePage: false

featuredImage: ""
featuredImagePreview: ""

toc: true
autoCollapseToc: true
math: true
lightgallery: true
linkToMarkdown: true
---

äº†è§£å¦‚ä½•ä½¿ç”¨ SQL çª—å£å‡½æ•°ã€‚

<!--more-->

{{% admonition æ›´æ–°è¯´æ˜ æ›´æ–°è¯´æ˜ %}} 

2020-10-10 æ–°å¢ [ä½¿ç”¨ Hive SQL çš„çª—å£å‡½æ•°è¿›è¡Œå•†åŠ¡æ•°æ®åˆ†æ](https://jiamaoxiang.top/2020/09/07/%E4%BD%BF%E7%94%A8Hive-SQL%E7%9A%84%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E5%95%86%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/)

2020-10-01 æ–°å¢ [MySQL çª—å£å‡½æ•°](https://tding.top/archives/c6e31643.html) 

2020-10-01 ä¿®è®¢ éƒ¨åˆ†æ–‡å­—å’Œæ’ç‰ˆ

 {{% /admonition %}}




## 1. çª—å£å‡½æ•°çš„ç®€ä»‹



**çª—å£å‡½æ•°**æ˜¯ä¸ºäº†å®ç° OLAP è€Œæ·»åŠ çš„æ ‡å‡† SQL åŠŸèƒ½ï¼Œä¹Ÿç§°ä¸º OLAP å‡½æ•°ï¼ˆOnLine Analytical Processing çš„ç®€ç§°ï¼ŒæŒ‡ [**è”æœºåˆ†æå¤„ç†**](https://zh.wikipedia.org/wiki/%E7%B7%9A%E4%B8%8A%E5%88%86%E6%9E%90%E8%99%95%E7%90%86) ï¼‰ï¼Œå…¶ä½œç”¨æ˜¯å°†è¡¨ä»¥çª—å£ä¸ºå•ä½è¿›è¡Œåˆ†å‰²ï¼Œå¹¶åœ¨å…¶ä¸­è¿›è¡Œæ’åºã€‚

ğŸ˜˜**æ³¨æ„**ï¼šä» **MySQL 8.0** å¼€å§‹æ”¯æŒçª—å£å‡½æ•°ã€‚

çª—å£å‡½æ•°å’Œæ™®é€šèšåˆå‡½æ•°å¾ˆå®¹æ˜“æ··æ·†ï¼ŒäºŒè€…åŒºåˆ«å¦‚ä¸‹ï¼š

- **èšåˆå‡½æ•°æ˜¯å°†å¤šæ¡è®°å½•èšåˆä¸ºä¸€æ¡ï¼›è€Œçª—å£å‡½æ•°æ˜¯æ¯æ¡è®°å½•éƒ½ä¼šæ‰§è¡Œï¼Œæœ‰å‡ æ¡è®°å½•æ‰§è¡Œå®Œè¿˜æ˜¯å‡ æ¡**ã€‚
- èšåˆå‡½æ•°ä¹Ÿå¯ä»¥ç”¨äºçª—å£å‡½æ•°ä¸­ã€‚

## 2. çª—å£å‡½æ•°çš„è¯­æ³•

```sql
# [] ä¸­çš„å†…å®¹å¯ä»¥çœç•¥
<çª—å£å‡½æ•°> OVER ([PARTITION BY <åˆ—æ¸…å•>] ORDER BY <æ’åºç”¨åˆ—æ¸…å•>)
```

å°ç»“ï¼šçª—å£å‡½æ•°å…¼å…·åˆ†ç»„å’Œæ’åºä¸¤ç§åŠŸèƒ½ï¼Œé€šè¿‡ `PARTITION BY` åˆ†ç»„åçš„è®°å½•é›†åˆç§°ä¸ºâ€œçª—å£â€ï¼Œ`PARTITION BY` è®¾å®šæ’åºçš„å¯¹è±¡èŒƒå›´ï¼Œ`ORDER BY` æŒ‡å®šæŒ‰ç…§å“ªä¸€åˆ—ã€ä½•ç§é¡ºåºè¿›è¡Œæ’åºã€‚

è¯´æ˜ï¼š PARTITION BY å’Œ GROUP BY çš„åŒºåˆ« ï¼Ÿ

 `PARTITION BY` è¿”å›åˆ†ç»„é‡Œçš„æ¯ä¸€è¡Œæ•°æ®ï¼Œ`GROUP BY` è¿”å›åˆ†ç»„é‡Œçš„ä»…ä¸€è¡Œæ•°æ®




## 3. çª—å£å‡½æ•°çš„ç±»å‹

ä¸€èˆ¬æŒ‰ç…§åŠŸèƒ½åˆ’åˆ†å¯å°†çª—å£å‡½æ•°åˆ†ä¸ºèšåˆçª—å£å‡½æ•°å’Œä¸“é—¨çª—å£å‡½æ•°ï¼ˆå¦‚æ’åçª—å£å‡½æ•°ï¼‰ã€‚



### 3.1 èšåˆçª—å£å‡½æ•°

> ä»¥**å½“å‰è®°å½•**ä½œä¸ºåŸºå‡†è¿›è¡Œ**ç´¯è®¡**ï¼Œæ˜¯èšåˆçª—å£å‡½æ•°çš„æœ€å¤§ç‰¹å¾

æŒ‡å®š â€œæœ€é è¿‘çš„ 3 è¡Œâ€ ä½œä¸ºæ±‡æ€»å¯¹è±¡ï¼Œè¾“å…¥ä»¥ä¸‹æµ‹è¯•ä»£ç ï¼š

```sql
# æŒ‡å®š â€œæœ€é è¿‘çš„ 3 è¡Œâ€ ä½œä¸ºæ±‡æ€»å¯¹è±¡
SELECT product_id, product_name, sale_price,
	AVG (sale_price) OVER (ORDER BY product_id ROWS 2 PRECEDING) AS moving_avg
FROM Product;
```

å…¶ç»“æœè¾“å‡ºï¼š


| product_id | product_name | sale_price | moving_avg |
| :--------: | :----------: | :--------: | :--------: |
| 0001       | Tæ¤è¡«        | 1000        | 1000       |
| 0002       | æ‰“å­”å™¨        | 500         | 750        |
| 0003       | è¿åŠ¨Tæ¤       | 4000        | 1833       |
| 0004       | èœåˆ€          | 3000       | 2500       |
| 0005       | é«˜å‹é”…        | 6800       | 4600       |
| 0006       | å‰å­          | 500        | 3433       |
| 0007       | æ“¦èœæ¿        | 880        | 2726       |
| 0008       | åœ†ç ç¬”        | 100        | 493        |

å°†å½“å‰è®°å½•çš„å‰åè¡Œä½œä¸ºæ±‡æ€»å¯¹è±¡ï¼ŒSQL è¯­å¥å¦‚ä¸‹ï¼š

```sql
# å°†å½“å‰è®°å½•çš„å‰åè¡Œä½œä¸ºæ±‡æ€»å¯¹è±¡
SELECT product_id, product_name, sale_price,
	AVG(sale_price) OVER(ORDER BY product_id 
	ROWS BETWEEN 1 PRECEDING AND 1 FOLLOWING) AS moving_avg 
FROM Product;
```

è¾“å‡ºç»“æœï¼š

| product_id | product_name | sale_price | moving_avg |
| :--------: | :----------: | :--------: | :--------: |
|       0001 | Tæ¤è¡«        |       1000 |        750 |
|       0002 | æ‰“å­”å™¨       |        500 |       1833 |
|       0003 | è¿åŠ¨Tæ¤      |       4000 |       2500 |
|       0004 | èœåˆ€         |       3000 |       4600 |
|       0005 | é«˜å‹é”…       |       6800 |       3433 |
|       0006 | å‰å­         |        500 |       2726 |
|       0007 | æ“¦èœæ¿       |        880 |        493 |
|       0008 | åœ†ç ç¬”       |        100 |        490 |



ğŸ˜€è¯´æ˜ï¼š`ROWS` æŒ‡å®šæ¡†æ¶ï¼Œ`PRECEDING` å°†æ¡†æ¶æŒ‡å®šä¸ºâ€œæˆªæ­¢åˆ°ä¹‹**å‰** ~ è¡Œâ€ï¼Œ`FOLLOWING`  å°†æ¡†æ¶æŒ‡å®šä¸ºâ€œæˆªæ­¢åˆ°ä¹‹**å** ~ è¡Œâ€



### 3.2 æ’åçª—å£å‡½æ•°



æ’åçª—å£å‡½æ•°æµ‹è¯•ä»£ç ï¼š

```sql
SELECT product_name, product_type, sale_price,
	RANK () OVER (ORDER BY sale_price) AS ranking,
	DENSE_RANK () OVER (ORDER BY sale_price) AS dense_ranking,
	ROW_NUMBER () OVER (ORDER BY sale_price) AS row_num
FROM Product;
```

ç»“æœè¾“å‡ºï¼š

| product_name | product_type | sale_price | ranking | dense_ranking | row_num |
| :----------: | :----------: | :--------: | :-----: | :-----------: | :-----: |
| åœ†ç ç¬”       | åŠå…¬ç”¨å“     |        100 |       1 |             1 |       1 |
| å‰å­         | å¨æˆ¿ç”¨å…·     |        500 |       2 |             2 |       2 |
| æ‰“å­”å™¨       | åŠå…¬ç”¨å“     |        500 |       2 |             2 |       3 |
| æ“¦èœæ¿       | å¨æˆ¿ç”¨å…·     |        880 |       4 |             3 |       4 |
| Tæ¤è¡«        | è¡£æœ         |       1000 |       5 |             4 |       5 |
| èœåˆ€         | å¨æˆ¿ç”¨å…·     |       3000 |       6 |             5 |       6 |
| è¿åŠ¨Tæ¤      | è¡£æœ         |       4000 |       7 |             6 |       7 |
| é«˜å‹é”…       | å¨æˆ¿ç”¨å…·     |       6800 |       8 |             7 |       8 |



### 3.3 MySQL æ”¯æŒçš„çª—å£å‡½æ•°

æŒ‰ç…§åŠŸèƒ½åˆ’åˆ†ï¼Œå¯ä»¥æŠŠ MySQL æ”¯æŒçš„çª—å£å‡½æ•°åˆ†ä¸ºå¦‚ä¸‹å‡ ç±»ï¼š

- åºå·å‡½æ•°ï¼šrow_number () /rank () /dense_rank ()
- åˆ†å¸ƒå‡½æ•°ï¼špercent_rank () /cume_dist ()
- å‰åå‡½æ•°ï¼šlag () /lead ()
- å¤´å°¾å‡½æ•°ï¼šfirst_val () /last_val ()
- å…¶ä»–å‡½æ•°ï¼šnth_value () /nfile ()

åˆ†å¸ƒå‡½æ•° cume_dist ()

ç”¨é€”ï¼šåˆ†ç»„å†…å¤§äºç­‰äºå½“å‰ rank å€¼çš„è¡Œæ•° / åˆ†ç»„å†…æ€»è¡Œæ•°ã€‚

åº”ç”¨åœºæ™¯ï¼šå¤§äºç­‰äºå½“å‰è®¢å•é‡‘é¢çš„è®¢å•æ¯”ä¾‹æœ‰å¤šå°‘ã€‚

```sql
select 
rank() over w as row_num,
cume_dist() over w as percent,
order_id,user_no,amount,create_date
from order_info
window w as (partition by user_no order by amount desc);
+---------+---------+----------+---------+--------+---------------------+
| row_num | percent | order_id | user_no | amount | create_date         |
+---------+---------+----------+---------+--------+---------------------+
|       1 |     0.2 |        5 | u0001   |    900 | 2018-01-20 00:00:00 |
|       2 |     0.4 |        4 | u0001   |    800 | 2018-01-10 00:00:00 |
|       3 |     0.8 |        2 | u0001   |    300 | 2018-01-02 00:00:00 |
|       3 |     0.8 |        3 | u0001   |    300 | 2018-01-02 00:00:00 |
|       5 |       1 |        1 | u0001   |    100 | 2018-01-01 00:00:00 |
|       1 |     0.4 |        9 | u0002   |    800 | 2018-01-16 00:00:00 |
|       1 |     0.4 |       10 | u0002   |    800 | 2018-01-22 00:00:00 |
|       3 |     0.6 |        7 | u0002   |    600 | 2018-01-06 00:00:00 |
|       4 |     0.8 |        6 | u0002   |    500 | 2018-01-05 00:00:00 |
|       5 |       1 |        8 | u0002   |    300 | 2018-01-10 00:00:00 |
+---------+---------+----------+---------+--------+---------------------+
```

å‰åå‡½æ•° lag ()ã€lead ()

ç”¨é€”ï¼š

- lag (column,n) è·å–å½“å‰æ•°æ®è¡ŒæŒ‰ç…§æŸç§æ’åºè§„åˆ™çš„ä¸Š n è¡Œæ•°æ®çš„æŸä¸ªå­—æ®µ
- lead (column,n) è·å–å½“å‰æ•°æ®è¡ŒæŒ‰ç…§æŸç§æ’åºè§„åˆ™çš„ä¸‹ n è¡Œæ•°æ®çš„æŸä¸ªå­—æ®µ

åº”ç”¨åœºæ™¯ï¼šæŒ‰ç…§æ—¶é—´æ’åºï¼Œè·å–å½“å‰è®¢å•çš„ä¸Šä¸€ç¬”è®¢å•å‘ç”Ÿæ—¶é—´å’Œä¸‹ä¸€ç¬”è®¢å•å‘ç”Ÿæ—¶é—´ï¼Œï¼ˆå¯ä»¥è®¡ç®—è®¢å•çš„æ—¶é—´ä¸Šçš„é—´éš”åº¦æˆ–è€…è¯´ä¹°ä¹°ä¹°çš„é¢‘ç¹ç¨‹åº¦ï¼‰ã€‚

```sql
select 
order_id,user_no,amount,create_date,
lag(create_date,1) over w 'last_transaction_time',
lead(create_date,1) over w 'next_transaction_time'
from order_info
window w as (partition by user_no order by create_date asc);
+----------+---------+--------+---------------------+-----------------------+-----------------------+
| order_id | user_no | amount | create_date         | last_transaction_time | next_transaction_time |
+----------+---------+--------+---------------------+-----------------------+-----------------------+
|        1 | u0001   |    100 | 2018-01-01 00:00:00 | NULL                  | 2018-01-02 00:00:00   |
|        2 | u0001   |    300 | 2018-01-02 00:00:00 | 2018-01-01 00:00:00   | 2018-01-02 00:00:00   |
|        3 | u0001   |    300 | 2018-01-02 00:00:00 | 2018-01-02 00:00:00   | 2018-01-10 00:00:00   |
|        4 | u0001   |    800 | 2018-01-10 00:00:00 | 2018-01-02 00:00:00   | 2018-01-20 00:00:00   |
|        5 | u0001   |    900 | 2018-01-20 00:00:00 | 2018-01-10 00:00:00   | NULL                  |
|        6 | u0002   |    500 | 2018-01-05 00:00:00 | NULL                  | 2018-01-06 00:00:00   |
|        7 | u0002   |    600 | 2018-01-06 00:00:00 | 2018-01-05 00:00:00   | 2018-01-10 00:00:00   |
|        8 | u0002   |    300 | 2018-01-10 00:00:00 | 2018-01-06 00:00:00   | 2018-01-16 00:00:00   |
|        9 | u0002   |    800 | 2018-01-16 00:00:00 | 2018-01-10 00:00:00   | 2018-01-22 00:00:00   |
|       10 | u0002   |    800 | 2018-01-22 00:00:00 | 2018-01-16 00:00:00   | NULL                  |
+----------+---------+--------+---------------------+-----------------------+-----------------------+
```



å¤´å°¾å‡½æ•° first_value ()ã€last_value ()

ç”¨é€”ï¼šå¤´å°¾å‡½æ•°å¯ä»¥å¾—åˆ°åˆ†åŒºä¸­çš„ç¬¬ä¸€ä¸ª / æœ€åä¸€ä¸ªæŒ‡å®šå‚æ•°çš„å€¼ã€‚

åº”ç”¨åœºæ™¯ï¼šæŸ¥è¯¢æˆªæ­¢åˆ°å½“å‰è®¢å•ï¼ŒæŒ‰ç…§æ—¥æœŸæ’åºç¬¬ä¸€ä¸ªè®¢å•å’Œæœ€åä¸€ä¸ªè®¢å•çš„è®¢å•é‡‘é¢ã€‚

```sql
select 
order_id,user_no,amount,create_date,
first_value(create_date) over w 'first_transaction_time',
last_value(create_date) over w 'last_transaction_time'
from order_info
window w as (partition by user_no order by create_date asc);
+----------+---------+--------+---------------------+------------------------+-----------------------+
| order_id | user_no | amount | create_date         | first_transaction_time | last_transaction_time |
+----------+---------+--------+---------------------+------------------------+-----------------------+
|        1 | u0001   |    100 | 2018-01-01 00:00:00 | 2018-01-01 00:00:00    | 2018-01-01 00:00:00   |
|        2 | u0001   |    300 | 2018-01-02 00:00:00 | 2018-01-01 00:00:00    | 2018-01-02 00:00:00   |
|        3 | u0001   |    300 | 2018-01-02 00:00:00 | 2018-01-01 00:00:00    | 2018-01-02 00:00:00   |
|        4 | u0001   |    800 | 2018-01-10 00:00:00 | 2018-01-01 00:00:00    | 2018-01-10 00:00:00   |
|        5 | u0001   |    900 | 2018-01-20 00:00:00 | 2018-01-01 00:00:00    | 2018-01-20 00:00:00   |
|        6 | u0002   |    500 | 2018-01-05 00:00:00 | 2018-01-05 00:00:00    | 2018-01-05 00:00:00   |
|        7 | u0002   |    600 | 2018-01-06 00:00:00 | 2018-01-05 00:00:00    | 2018-01-06 00:00:00   |
|        8 | u0002   |    300 | 2018-01-10 00:00:00 | 2018-01-05 00:00:00    | 2018-01-10 00:00:00   |
|        9 | u0002   |    800 | 2018-01-16 00:00:00 | 2018-01-05 00:00:00    | 2018-01-16 00:00:00   |
|       10 | u0002   |    800 | 2018-01-22 00:00:00 | 2018-01-05 00:00:00    | 2018-01-22 00:00:00   |
+----------+---------+--------+---------------------+------------------------+-----------------------+
```



ğŸ˜±æ³¨æ„ï¼šå¦‚æœä¸åŠ  `order by`, å°±æ²¡æœ‰çª—å£ï¼Œè®¡ç®—èŒƒå›´æ˜¯æ•´ä¸ªåˆ†åŒºï¼›å¦‚æœåŠ ä¸Š `order by`, é»˜è®¤çª—å£æ˜¯ `range between unbounded preceding and current row`ï¼Œå°±æ˜¯æ’åºåä»åˆ†åŒºç¬¬ä¸€è¡Œä¸€ç›´åˆ°å½“å‰è¡Œä¸ºæ­¢ã€‚

ç”±äºæˆ‘ä»¬éœ€è¦æ±‚çš„æ˜¯æ¯ä¸ªç”¨æˆ·çš„ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªè®¢å•ï¼Œæ‰€ä»¥è¿™é‡Œè¦æŒ‡å®šçª—å£ï¼šä»ç¬¬ä¸€è¡Œ `unbounded preceding` åˆ°æœ€åä¸€è¡Œ `unbounded following`ã€‚

```sql
select 
order_id,user_no,amount,create_date,
first_value(create_date) over w 'first_transaction_time',
last_value(create_date) over w 'last_transaction_time'
from order_info
window w as (partition by user_no order by create_date asc rows between unbounded preceding and unbounded following);
+----------+---------+--------+---------------------+------------------------+-----------------------+
| order_id | user_no | amount | create_date         | first_transaction_time | last_transaction_time |
+----------+---------+--------+---------------------+------------------------+-----------------------+
|        1 | u0001   |    100 | 2018-01-01 00:00:00 | 2018-01-01 00:00:00    | 2018-01-20 00:00:00   |
|        2 | u0001   |    300 | 2018-01-02 00:00:00 | 2018-01-01 00:00:00    | 2018-01-20 00:00:00   |
|        3 | u0001   |    300 | 2018-01-02 00:00:00 | 2018-01-01 00:00:00    | 2018-01-20 00:00:00   |
|        4 | u0001   |    800 | 2018-01-10 00:00:00 | 2018-01-01 00:00:00    | 2018-01-20 00:00:00   |
|        5 | u0001   |    900 | 2018-01-20 00:00:00 | 2018-01-01 00:00:00    | 2018-01-20 00:00:00   |
|        6 | u0002   |    500 | 2018-01-05 00:00:00 | 2018-01-05 00:00:00    | 2018-01-22 00:00:00   |
|        7 | u0002   |    600 | 2018-01-06 00:00:00 | 2018-01-05 00:00:00    | 2018-01-22 00:00:00   |
|        8 | u0002   |    300 | 2018-01-10 00:00:00 | 2018-01-05 00:00:00    | 2018-01-22 00:00:00   |
|        9 | u0002   |    800 | 2018-01-16 00:00:00 | 2018-01-05 00:00:00    | 2018-01-22 00:00:00   |
|       10 | u0002   |    800 | 2018-01-22 00:00:00 | 2018-01-05 00:00:00    | 2018-01-22 00:00:00   |
+----------+---------+--------+---------------------+------------------------+-----------------------+
```



## 4. çª—å£å‡½æ•°çš„åº”ç”¨åœºæ™¯

ä¸‹é¢è¿™ç¯‡æ–‡ç« è½¬è½½è‡ª [Jmx's Blog](https://jiamaoxiang.top/)ï¼ŒåŸæ–‡é“¾æ¥ï¼š [ä½¿ç”¨Hive SQLçš„çª—å£å‡½æ•°è¿›è¡Œå•†åŠ¡æ•°æ®åˆ†æ](https://jiamaoxiang.top/2020/09/07/%E4%BD%BF%E7%94%A8Hive-SQL%E7%9A%84%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E5%95%86%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/) ã€‚

è¿™ç¯‡æ–‡ç« ä»ä¸€ä¸ªå•†åŠ¡åˆ†ææ¡ˆä¾‹å…¥æ‰‹ï¼Œè¯´æ˜ SQL çª—å£å‡½æ•°çš„ä½¿ç”¨æ–¹å¼ã€‚

é€šè¿‡æœ¬æ–‡çš„ 5 ä¸ªéœ€æ±‚åˆ†æï¼Œå¯ä»¥çœ‹å‡º SQL çª—å£å‡½æ•°çš„åŠŸèƒ½ååˆ†å¼ºå¤§ï¼Œä¸ä»…èƒ½å¤Ÿä½¿æˆ‘ä»¬ç¼–å†™çš„ SQL é€»è¾‘æ›´åŠ æ¸…æ™°ï¼Œè€Œä¸”åœ¨æŸç§ç¨‹åº¦ä¸Šå¯ä»¥ç®€åŒ–éœ€æ±‚å¼€å‘ã€‚

è½¬è½½æ—¶ï¼Œåšäº†ä¸€äº›æ–‡å­—å’Œæ ¼å¼ä¸Šçš„ä¿®è®¢ã€‚

> ä½¿ç”¨ Hive SQL çš„çª—å£å‡½æ•°è¿›è¡Œå•†åŠ¡æ•°æ®åˆ†æ [Jmx's Blog](https://jiamaoxiang.top/2020/09/07/%E4%BD%BF%E7%94%A8Hive-SQL%E7%9A%84%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E5%95%86%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/)

### 4.0 æ•°æ®å‡†å¤‡

æœ¬æ–‡ä¸»è¦åˆ†æåªæ¶‰åŠä¸€å¼ è®¢å•è¡¨ ordersï¼Œæ“ä½œè¿‡ç¨‹åœ¨ Hive ä¸­å®Œæˆï¼Œå…·ä½“æ•°æ®å¦‚ä¸‹ï¼š

```sql
-- å»ºè¡¨
CREATE TABLE orders(
    order_id int,
    customer_id string,
    city string,
    add_time string,
    amount decimal(10,2));

-- å‡†å¤‡æ•°æ®                              
INSERT INTO orders VALUES
(1,"A","ä¸Šæµ·","2020-01-01 00:00:00.000000",200),
(2,"B","ä¸Šæµ·","2020-01-05 00:00:00.000000",250),
(3,"C","åŒ—äº¬","2020-01-12 00:00:00.000000",200),
(4,"A","ä¸Šæµ·","2020-02-04 00:00:00.000000",400),
(5,"D","ä¸Šæµ·","2020-02-05 00:00:00.000000",250),
(5,"D","ä¸Šæµ·","2020-02-05 12:00:00.000000",300),
(6,"C","åŒ—äº¬","2020-02-19 00:00:00.000000",300),
(7,"A","ä¸Šæµ·","2020-03-01 00:00:00.000000",150),
(8,"E","åŒ—äº¬","2020-03-05 00:00:00.000000",500),
(9,"F","ä¸Šæµ·","2020-03-09 00:00:00.000000",250),
(10,"B","ä¸Šæµ·","2020-03-21 00:00:00.000000",600);
```

### 4.1 éœ€æ±‚1ï¼šæ”¶å…¥å¢é•¿

åœ¨ä¸šåŠ¡æ–¹é¢ï¼Œç¬¬ m1 ä¸ªæœˆçš„æ”¶å…¥å¢é•¿è®¡ç®—å¦‚ä¸‹ï¼š**100 \*ï¼ˆm1-m0ï¼‰/ m0**

å…¶ä¸­ï¼Œm1 æ˜¯ç»™å®šæœˆä»½çš„æ”¶å…¥ï¼Œm0 æ˜¯ä¸Šä¸ªæœˆçš„æ”¶å…¥ã€‚å› æ­¤ï¼Œä»æŠ€æœ¯ä¸Šè®²ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ¯ä¸ªæœˆçš„æ”¶å…¥ï¼Œç„¶åä»¥æŸç§æ–¹å¼å°†æ¯ä¸ªæœˆçš„æ”¶å…¥ä¸ä¸Šä¸€ä¸ªæ”¶å…¥ç›¸å…³è”ï¼Œä»¥ä¾¿è¿›è¡Œä¸Šè¿°è®¡ç®—ã€‚è®¡ç®—å½“æ—¶å¦‚ä¸‹ï¼š

```sql
WITH
monthly_revenue as (
    SELECT
    trunc(add_time,'MM') as month,
    sum(amount) as revenue
    FROM orders
    GROUP BY 1
)
,prev_month_revenue as (
    SELECT 
    month,
    revenue,
    lag(revenue) over (order by month) as prev_month_revenue -- ä¸Šä¸€æœˆæ”¶å…¥
    FROM monthly_revenue
)
SELECT 
  month,
  revenue,
  prev_month_revenue,
  round(100.0*(revenue-prev_month_revenue)/prev_month_revenue,1) as revenue_growth
FROM prev_month_revenue
ORDER BY 1
```

ç»“æœè¾“å‡ºï¼š

| month      | revenue | prev_month_revenue | revenue_growth |
| :--------: | :-----: | :----------------: | :------------: |
| 2020-01-01 | 650     | NULL               | NULL           |
| 2020-02-01 | 1250    | 650                | 92.3           |
| 2020-03-01 | 1500    | 1250               | 20             |

æˆ‘ä»¬è¿˜å¯ä»¥æŒ‰ç…§æŒ‰åŸå¸‚åˆ†ç»„è¿›è¡Œç»Ÿè®¡ï¼ŒæŸ¥çœ‹æŸä¸ªåŸå¸‚æŸä¸ªæœˆä»½çš„æ”¶å…¥å¢é•¿æƒ…å†µ

```sql
WITH
monthly_revenue as (
    SELECT
     trunc(add_time,'MM') as month,
    city,
    sum(amount) as revenue
    FROM orders
    GROUP BY 1,2
)
,prev_month_revenue as (
    SELECT 
    month,
    city,
    revenue,
    lag(revenue) over (partition by city order by month) as prev_month_revenue
    FROM monthly_revenue
)
SELECT 
month,
city,
revenue,
round(100.0*(revenue-prev_month_revenue)/prev_month_revenue,1) as revenue_growth
FROM prev_month_revenue
ORDER BY 2,1
```

ç»“æœè¾“å‡ºï¼š

| month      | city | revenue | revenue_growth |
| :--------: | :--: | :-----: | :------------: |
| 2020-01-01 | ä¸Šæµ· | 450     | NULL           |
| 2020-02-01 | ä¸Šæµ· | 950     | 111.1          |
| 2020-03-01 | ä¸Šæµ· | 1000    | 5.3            |
| 2020-01-01 | åŒ—äº¬ | 200     | NULL           |
| 2020-02-01 | åŒ—äº¬ | 300     | 50             |
| 2020-03-01 | åŒ—äº¬ | 500     | 66.7           |

### 4.2 éœ€æ±‚2ï¼šç´¯è®¡æ±‚å’Œ

ç´¯è®¡æ±‡æ€»ï¼Œå³å½“å‰å…ƒç´ å’Œæ‰€æœ‰å…ˆå‰å…ƒç´ çš„æ€»å’Œï¼Œå¦‚ä¸‹é¢çš„ SQLï¼š

```sql
WITH
monthly_revenue as (
    SELECT
    trunc(add_time,'MM') as month,
    sum(amount) as revenue
    FROM orders
    GROUP BY 1
)
SELECT 
month,
revenue,
sum(revenue) over (order by month rows between unbounded preceding and current row) as running_total
FROM monthly_revenue
ORDER BY 1
```

ç»“æœè¾“å‡ºï¼š

| month      | revenue | running_total |
| :--------: | :-----: | :-----------: |
| 2020-01-01 | 650     | 650           |
| 2020-02-01 | 1250    | 1900          |
| 2020-03-01 | 1500    | 3400          |

æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ç»„åˆæ–¹å¼è¿›è¡Œåˆ†æï¼ŒSQL å¦‚ä¸‹ï¼š

```sql
SELECT
   order_id,
   customer_id,
   city,
   add_time,
   amount,
   sum(amount) over () as amount_total, -- æ‰€æœ‰æ•°æ®æ±‚å’Œ
   sum(amount) over (order by order_id rows between unbounded preceding and current row) as running_sum, -- ç´¯è®¡æ±‚å’Œ
   sum(amount) over (partition by customer_id order by add_time rows between unbounded    preceding and current row) as running_sum_by_customer, 
   avg(amount) over (order by add_time rows between 5 preceding and current row) as  trailing_avg -- æ»šåŠ¨æ±‚å¹³å‡
FROM orders
ORDER BY 1
```

ç»“æœè¾“å‡ºï¼š

| order_id | customer_id | city | add_time                   | amount | amount_total | running_sum | running_sum_by_customer | trailing_avg |
| :------: | :---------: | :--: | :------------------------: | :----: | :----------: | :---------: | :---------------------: | :----------: |
| 1        | A           | ä¸Šæµ· | 2020-01-01 00:00:00.000000 | 200    | 3400         | 200         | 200                     | 200          |
| 2        | B           | ä¸Šæµ· | 2020-01-05 00:00:00.000000 | 250    | 3400         | 450         | 250                     | 225          |
| 3        | C           | åŒ—äº¬ | 2020-01-12 00:00:00.000000 | 200    | 3400         | 650         | 200                     | 216.666667   |
| 4        | A           | ä¸Šæµ· | 2020-02-04 00:00:00.000000 | 400    | 3400         | 1050        | 600                     | 262.5        |
| 5        | D           | ä¸Šæµ· | 2020-02-05 00:00:00.000000 | 250    | 3400         | 1300        | 250                     | 260          |
| 5        | D           | ä¸Šæµ· | 2020-02-05 12:00:00.000000 | 300    | 3400         | 1600        | 550                     | 266.666667   |
| 6        | C           | åŒ—äº¬ | 2020-02-19 00:00:00.000000 | 300    | 3400         | 1900        | 500                     | 283.333333   |
| 7        | A           | ä¸Šæµ· | 2020-03-01 00:00:00.000000 | 150    | 3400         | 2050        | 750                     | 266.666667   |
| 8        | E           | åŒ—äº¬ | 2020-03-05 00:00:00.000000 | 500    | 3400         | 2550        | 500                     | 316.666667   |
| 9        | F           | ä¸Šæµ· | 2020-03-09 00:00:00.000000 | 250    | 3400         | 2800        | 250                     | 291.666667   |
| 10       | B           | ä¸Šæµ· | 2020-03-21 00:00:00.000000 | 600    | 3400         | 3400        | 850                     |              |

### 4.3 éœ€æ±‚3ï¼šå¤„ç†é‡å¤æ•°æ®

ä»ä¸Šé¢çš„æ•°æ®å¯ä»¥çœ‹å‡ºï¼Œå­˜åœ¨ä¸¤æ¡é‡å¤çš„æ•°æ®**(5,â€Dâ€,â€ä¸Šæµ·â€,â€2020-02-05 00:00:00.000000â€,250),
(5,â€Dâ€,â€ä¸Šæµ·â€,â€2020-02-05 12:00:00.000000â€,300),**æ˜¾ç„¶éœ€è¦å¯¹å…¶è¿›è¡Œæ¸…æ´—å»é‡ï¼Œä¿ç•™æœ€æ–°çš„ä¸€æ¡æ•°æ®ï¼ŒSQL å¦‚ä¸‹ï¼š

æˆ‘ä»¬å…ˆè¿›è¡Œåˆ†ç»„æ’åï¼Œç„¶åä¿ç•™æœ€æ–°çš„é‚£æ¡æ•°æ®å³å¯ï¼š

```sql
SELECT *
FROM (
    SELECT *,
    row_number() over (partition by order_id order by add_time desc) as rank
    FROM orders
) t
WHERE rank=1
```

ç»“æœè¾“å‡ºï¼š

| t.order_id | t.customer_id | t.city | t.add_time                 | t.amount | t.rank |
| :--------: | :-----------: | :----: | :------------------------: | :------: | :----: |
| 1          | A             | ä¸Šæµ·   | 2020-01-01 00:00:00.000000 | 200      | 1      |
| 2          | B             | ä¸Šæµ·   | 2020-01-05 00:00:00.000000 | 250      | 1      |
| 3          | C             | åŒ—äº¬   | 2020-01-12 00:00:00.000000 | 200      | 1      |
| 4          | A             | ä¸Šæµ·   | 2020-02-04 00:00:00.000000 | 400      | 1      |
| 5          | D             | ä¸Šæµ·   | 2020-02-05 12:00:00.000000 | 300      | 1      |
| 6          | C             | åŒ—äº¬   | 2020-02-19 00:00:00.000000 | 300      | 1      |
| 7          | A             | ä¸Šæµ·   | 2020-03-01 00:00:00.000000 | 150      | 1      |
| 8          | E             | åŒ—äº¬   | 2020-03-05 00:00:00.000000 | 500      | 1      |
| 9          | F             | ä¸Šæµ·   | 2020-03-09 00:00:00.000000 | 250      | 1      |
| 10         | B             | ä¸Šæµ·   | 2020-03-21 00:00:00.000000 | 600      | 1      |

ç»è¿‡ä¸Šé¢çš„æ¸…æ´—è¿‡ç¨‹ï¼Œå¯¹æ•°æ®è¿›è¡Œäº†å»é‡ã€‚é‡æ–°è®¡ç®—ä¸Šé¢çš„éœ€æ±‚1ï¼Œæ­£ç¡® SQL è„šæœ¬ä¸ºï¼š

```sql
WITH
orders_cleaned as (
    SELECT *
    FROM (
        SELECT *,
        row_number() over (partition by order_id order by add_time desc) as rank
        FROM orders
    )t
    WHERE rank=1
)
,monthly_revenue as (
    SELECT
    trunc(add_time,'MM') as month,
    sum(amount) as revenue
    FROM orders_cleaned
    GROUP BY 1
)
,prev_month_revenue as (
    SELECT 
    month,
    revenue,
    lag(revenue) over (order by month) as prev_month_revenue
    FROM monthly_revenue
)
SELECT 
month,
revenue,
round(100.0*(revenue-prev_month_revenue)/prev_month_revenue,1) as revenue_growth
FROM prev_month_revenue
ORDER BY 1
```

ç»“æœè¾“å‡ºï¼š

| month      | revenue | revenue_growth |
| :--------: | :-----: | :------------: |
| 2020-01-01 | 650     | NULL           |
| 2020-02-01 | 1000    | 53.8           |
| 2020-03-01 | 1500    | 50             |

å°†æ¸…æ´—åçš„æ•°æ®åˆ›å»ºæˆè§†å›¾ï¼Œæ–¹ä¾¿ä»¥åä½¿ç”¨

```sql
CREATE VIEW orders_cleaned AS
SELECT
    order_id, 
    customer_id, 
    city, 
    add_time, 
    amount
FROM (
    SELECT *,
    row_number() over (partition by order_id order by add_time desc) as rank
    FROM orders
)t
WHERE rank=1
```

### 4.4 éœ€æ±‚4ï¼šåˆ†ç»„å–TopN

åˆ†ç»„å– TopN æ˜¯æœ€é•¿è§çš„ SQL çª—å£å‡½æ•°ä½¿ç”¨åœºæ™¯ï¼Œä¸‹é¢çš„ SQL æ˜¯è®¡ç®—æ¯ä¸ªæœˆä»½çš„ top2 è®¢å•é‡‘é¢ï¼Œå¦‚ä¸‹ï¼š

```sql
WITH orders_ranked as (
    SELECT
    trunc(add_time,'MM') as month,
    *,
    row_number() over (partition by trunc(add_time,'MM') order by amount desc, add_time) as rank
    FROM orders_cleaned
)
SELECT 
    month,
    order_id,
    customer_id,
    city,
    add_time,
    amount
FROM orders_ranked
WHERE rank <=2
ORDER BY 1
```

### 4.5 éœ€æ±‚5ï¼šé‡å¤è´­ä¹°è¡Œä¸º

ä¸‹é¢çš„ SQL è®¡ç®—é‡å¤è´­ä¹°ç‡ï¼šé‡å¤è´­ä¹°çš„äººæ•°/æ€»äººæ•°*100%ä»¥åŠç¬¬ä¸€ç¬”è®¢å•é‡‘é¢ä¸ç¬¬äºŒç¬”è®¢å•é‡‘é¢ä¹‹é—´çš„å…¸å‹å·®é¢:avg(ç¬¬äºŒç¬”è®¢å•é‡‘é¢/ç¬¬ä¸€ç¬”è®¢å•é‡‘é¢)

```sql
WITH customer_orders as (
    SELECT *,
    row_number() over (partition by customer_id order by add_time) as customer_order_n,
    lag(amount) over (partition by customer_id order by add_time) as prev_order_amount
    FROM orders_cleaned
)
SELECT
round(100.0*sum(case when customer_order_n=2 then 1 end)/count(distinct customer_id),1) as repeat_purchases,-- é‡å¤è´­ä¹°ç‡
avg(case when customer_order_n=2 then 1.0*amount/prev_order_amount end) as revenue_expansion -- é‡å¤è´­ä¹°è¾ƒä¸Šæ¬¡è´­ä¹°å·®å¼‚ï¼Œç¬¬ä¸€ç¬”è®¢å•é‡‘é¢ä¸ç¬¬äºŒç¬”è®¢å•é‡‘é¢ä¹‹é—´çš„å…¸å‹å·®é¢
FROM customer_orders
```

ç»“æœè¾“å‡ºï¼š

| orders_cleaned.order_id | orders_cleaned.customer_id | orders_cleaned.city | orders_cleaned.add_time    | orders_cleaned.amount | customer_order_n | prev_order_amount |
| :---------------------: | :------------------------: | :-----------------: | :------------------------: | :-------------------: | :--------------: | :---------------: |
| 1                       | A                          | ä¸Šæµ·                | 2020-01-01 00:00:00.000000 | 200                   | 1                | NULL              |
| 4                       | A                          | ä¸Šæµ·                | 2020-02-04 00:00:00.000000 | 400                   | 2                | 200               |
| 7                       | A                          | ä¸Šæµ·                | 2020-03-01 00:00:00.000000 | 150                   | 3                | 400               |
| 2                       | B                          | ä¸Šæµ·                | 2020-01-05 00:00:00.000000 | 250                   | 1                | NULL              |
| 10                      | B                          | ä¸Šæµ·                | 2020-03-21 00:00:00.000000 | 600                   | 2                | 250               |
| 3                       | C                          | åŒ—äº¬                | 2020-01-12 00:00:00.000000 | 200                   | 1                | NULL              |
| 6                       | C                          | åŒ—äº¬                | 2020-02-19 00:00:00.000000 | 300                   | 2                | 200               |
| 5                       | D                          | ä¸Šæµ·                | 2020-02-05 12:00:00.000000 | 300                   | 1                | NULL              |
| 8                       | E                          | åŒ—äº¬                | 2020-03-05 00:00:00.000000 | 500                   | 1                | NULL              |
| 9                       | F                          | ä¸Šæµ·                | 2020-03-09 00:00:00.000000 | 250                   |                  |                   |

æœ€ç»ˆç»“æœè¾“å‡ºï¼š

| repeat_purchases | revenue_expansion  |
| :--------------: | :----------------: |
| 50               | 1.9666666666666668 |



## 5. å‚è€ƒ

1. SQL åŸºç¡€æ•™ç¨‹ï¼ˆç¬¬ 2 ç‰ˆï¼‰- MICK (ä½œè€…) å­™æ·¼ , ç½—å‹‡ (è¯‘è€…) 
2. MySQL çª—å£å‡½æ•° https://tding.top/archives/c6e31643.html
3. ä½¿ç”¨ Hive SQL çš„çª—å£å‡½æ•°è¿›è¡Œå•†åŠ¡æ•°æ®åˆ†æ  [Jmx's Blog](https://jiamaoxiang.top/2020/09/07/%E4%BD%BF%E7%94%A8Hive-SQL%E7%9A%84%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E5%95%86%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/) 